name: Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources üî∞
      uses: actions/checkout@v5

    - name: Set up Java üìê
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: 17

    - name: Build artifacts üèóÔ∏è
      run: mvn clean package -B

    - name: Get artifact filename ü™™
      run: |
        ARTIFACT_FILE="$(mvn help:evaluate -Dexpression=project.build.finalName -q -DforceStdout)-$(mvn help:evaluate -Dexpression=gs.version -q -DforceStdout).jar"
        echo "artifact_file=$ARTIFACT_FILE" >> $GITHUB_ENV

    - name: Package artifact as ZIP üóúÔ∏è
      run: |
        mkdir -p release
        cp target/$artifact_file release/
        cd release
        zip "${artifact_file%.jar}.zip" "$artifact_file"

    - name: Create maven settings.xml with credentials
      uses: whelk-io/maven-settings-xml-action@v2
      with:
        servers: |
          [
            { "id": "nexus.terrestris.de-releases", "username": "${{ secrets.NEXUS_USER }}", "password": "${{ secrets.NEXUS_PASSWORD }}" }
          ]

    - name: Semantic release
      id: semantic
      uses: cycjimmy/semantic-release-action@v3
      with:
        semantic_version: 19
        extra_plugins: |
          @semantic-release/changelog@6
          @terrestris/maven-semantic-release@2
          @semantic-release/git@10
      env:
        GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

    - name: Upload ZIP to GitHub Release ‚¨ÜÔ∏è
      if: steps.semantic.outputs.released == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: release/${artifact_file%.jar}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
